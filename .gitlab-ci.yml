stages:
  - test
  - quality
  - build
  - release
  - deploy

variables:
  REGISTRY: $CI_REGISTRY
  IMAGE_NAME: $CI_PROJECT_PATH
  POSTGRES_DB: test
  POSTGRES_USER: test
  POSTGRES_PASSWORD: test

# ============================================================
# TEST STAGE
# ============================================================

backend-tests:
  stage: test
  image: php:8.4-cli

  services:
    - name: postgres:16-alpine
      alias: postgres

  variables:
    POSTGRES_DB: test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test

  before_script:
    - apt-get update && apt-get install -y libpq-dev libzip-dev zip git
    - docker-php-ext-install pdo_pgsql zip
    - pecl install xdebug && docker-php-ext-enable xdebug
    - cd backend
    # –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –¥–ª—è Symfony
    - |
      cat > .env << 'EOF'
      APP_ENV=test
      APP_SECRET=test_secret_for_ci
      DATABASE_URL=postgresql://test:test@postgres:5432/test?serverVersion=16
      DEFAULT_URI=http://localhost
      EOF
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --prefer-dist --no-progress --no-interaction

  script:
    - php bin/console doctrine:database:create --env=test
    - php bin/console doctrine:schema:create --env=test
    - php bin/phpunit

  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer
    paths:
      - backend/vendor/

  artifacts:
    when: always
    reports:
      junit: backend/coverage.xml
    paths:
      - backend/coverage.xml
    expire_in: 7 days

frontend-tests:
  stage: test
  image: node:22

  before_script:
    - corepack enable
    - cd frontend
    - pnpm install --frozen-lockfile

  script:
    - pnpm check || echo "Type check skipped"
    - pnpm test || echo "Tests skipped"
    - pnpm build

  cache:
    key: ${CI_COMMIT_REF_SLUG}-pnpm
    paths:
      - frontend/node_modules/
      - ~/.pnpm-store

  artifacts:
    paths:
      - frontend/build/
    expire_in: 7 days

# ============================================================
# QUALITY STAGE
# ============================================================

code-quality:
  stage: quality
  image: php:8.4-cli

  only:
    - merge_requests

  before_script:
    - apt-get update && apt-get install -y libpq-dev libzip-dev zip git
    - docker-php-ext-install pdo_pgsql zip
    - cd backend
    # –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –¥–ª—è Symfony
    - |
      cat > .env << 'EOF'
      APP_ENV=test
      APP_SECRET=test_secret_for_ci
      DATABASE_URL=postgresql://test:test@localhost:5432/test?serverVersion=16
      DEFAULT_URI=http://localhost
      EOF
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --prefer-dist --no-progress

  script:
    # PHP CS Fixer - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞
    - vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
    # PHPStan - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
    - vendor/bin/phpstan analyse src tests --memory-limit=2G
    # Deptrac - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (—Å–ª–æ–∏)
    - vendor/bin/deptrac --config-file=deptrac-layers.yaml
    # Deptrac - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–º–æ–¥—É–ª–∏)
    - vendor/bin/deptrac --config-file=deptrac-modules.yaml

  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer
    paths:
      - backend/vendor/

frontend-quality:
  stage: quality
  image: node:22

  only:
    - merge_requests

  before_script:
    - corepack enable
    - cd frontend
    - pnpm install --frozen-lockfile

  script:
    - pnpm lint || echo "Lint not configured"

  cache:
    key: ${CI_COMMIT_REF_SLUG}-pnpm
    paths:
      - frontend/node_modules/

security-audit:
  stage: quality
  image: php:8.4-cli

  before_script:
    - cd backend
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

  script:
    - composer audit || echo "No vulnerabilities"

  allow_failure: true

frontend-security:
  stage: quality
  image: node:22

  before_script:
    - corepack enable
    - cd frontend

  script:
    - pnpm audit || echo "No vulnerabilities"

  allow_failure: true

# ============================================================
# BUILD STAGE (—Ç–æ–ª—å–∫–æ –¥–ª—è main)
# ============================================================

build-php-fpm:
  stage: build
  image: docker:24

  services:
    - docker:24-dind

  only:
    - main
    - tags

  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

  script:
    - cd docker/php-fpm
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        # –î–ª—è —Ç–µ–≥–æ–≤ —Å–æ–∑–¥–∞–µ–º –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
        docker build --target production -t $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_TAG .
        docker build --target production -t $CI_REGISTRY/$IMAGE_NAME/php-fpm:latest .
        docker push $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_TAG
        docker push $CI_REGISTRY/$IMAGE_NAME/php-fpm:latest
      else
        # –î–ª—è main —Å–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–∑—ã —Å sha
        docker build --target production -t $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_REF_NAME .
        docker build --target production -t $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_SHORT_SHA .
        docker push $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_REF_NAME
        docker push $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_SHORT_SHA
      fi

build-nginx:
  stage: build
  image: docker:24

  services:
    - docker:24-dind

  only:
    - main
    - tags

  dependencies:
    - frontend-tests

  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        # –î–ª—è —Ç–µ–≥–æ–≤ —Å–æ–∑–¥–∞–µ–º –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
        docker build -f docker/nginx/Dockerfile.production -t $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_TAG .
        docker build -f docker/nginx/Dockerfile.production -t $CI_REGISTRY/$IMAGE_NAME/nginx:latest .
        docker push $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_TAG
        docker push $CI_REGISTRY/$IMAGE_NAME/nginx:latest
      else
        # –î–ª—è main —Å–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–∑—ã —Å sha
        docker build -f docker/nginx/Dockerfile.production -t $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_REF_NAME .
        docker build -f docker/nginx/Dockerfile.production -t $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_SHORT_SHA .
        docker push $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_REF_NAME
        docker push $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_SHORT_SHA
      fi

# ============================================================
# RELEASE STAGE (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ–≥–æ–≤)
# ============================================================

create-release:
  stage: release
  image: alpine:latest

  only:
    - tags

  when: manual

  before_script:
    - apk add --no-cache git curl jq
    - git fetch --tags

  script:
    - |
      TAG_NAME="$CI_COMMIT_TAG"

      # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–≥–∞
      if ! echo "$TAG_NAME" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+\.[0-9]+)?$'; then
        echo "‚ùå Invalid tag format: $TAG_NAME"
        echo "Tag must follow: vX.Y.Z or vX.Y.Z-beta.N (e.g., v1.0.0 or v1.0.0-beta.1)"
        exit 1
      fi
      echo "‚úÖ Valid tag format: $TAG_NAME"

      # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ pre-release
      IS_PRERELEASE="false"
      if echo "$TAG_NAME" | grep -qE '-(beta|rc|alpha)\.'; then
        IS_PRERELEASE="true"
        echo "‚ö†Ô∏è This is a pre-release version"
      else
        echo "‚úÖ This is a production release"
      fi

      # –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥
      PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')

      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è changelog
      echo "# üöÄ Release $TAG_NAME" > CHANGELOG.md
      echo "" >> CHANGELOG.md

      if [ -n "$PREV_TAG" ]; then
        echo "## üìù Changes since $PREV_TAG" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Features
        echo "### ‚ú® Features" >> CHANGELOG.md
        git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^feat" --grep="^feature" >> CHANGELOG.md || echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Bug Fixes
        echo "### üêõ Bug Fixes" >> CHANGELOG.md
        git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^fix" >> CHANGELOG.md || echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Documentation
        echo "### üìö Documentation" >> CHANGELOG.md
        git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^docs" >> CHANGELOG.md || echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Other Changes
        echo "### üîß Other Changes" >> CHANGELOG.md
        git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" \
          --invert-grep --grep="^feat" --grep="^fix" --grep="^docs" --grep="^feature" >> CHANGELOG.md || echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Statistics
        echo "### üìä Statistics" >> CHANGELOG.md
        COMMITS_COUNT=$(git rev-list --count $PREV_TAG..$TAG_NAME)
        FILES_CHANGED=$(git diff --shortstat $PREV_TAG..$TAG_NAME | awk '{print $1}')
        echo "- **Commits**: $COMMITS_COUNT" >> CHANGELOG.md
        echo "- **Files changed**: ${FILES_CHANGED:-0}" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        echo "**Full Changelog**: $CI_PROJECT_URL/compare/$PREV_TAG...$TAG_NAME" >> CHANGELOG.md
      else
        echo "## üéâ Initial Release" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "This is the first release of RunTracker!" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### Recent Commits" >> CHANGELOG.md
        git log --pretty=format:"- %s (%h)" -n 20 >> CHANGELOG.md || echo "" >> CHANGELOG.md
      fi

      cat CHANGELOG.md

      # –°–æ–∑–¥–∞—Ç—å release —á–µ—Ä–µ–∑ GitLab API
      CHANGELOG_BODY=$(cat CHANGELOG.md | jq -Rs .)

      curl --request POST "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "{
          \"tag_name\": \"$TAG_NAME\",
          \"name\": \"Release $TAG_NAME\",
          \"description\": $CHANGELOG_BODY,
          \"ref\": \"$CI_COMMIT_SHA\"
        }"

      echo "‚úÖ Release $TAG_NAME created successfully!"
      echo "üîó View release: $CI_PROJECT_URL/-/releases/$TAG_NAME"

  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 30 days

# ============================================================
# DEPLOY STAGE (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è production —Ä–µ–ª–∏–∑–æ–≤)
# ============================================================

deploy-production:
  stage: deploy
  image: alpine:latest

  only:
    - tags

  when: manual

  environment:
    name: production
    url: https://runtracker.yourdomain.com

  dependencies:
    - frontend-tests

  before_script:
    - apk add --no-cache openssh-client rsync tar
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts

  script:
    # –°–æ–∑–¥–∞—Ç—å deployment –∞—Ä—Ö–∏–≤
    - |
      tar czf deploy.tar.gz \
        docker-compose.yml \
        docker-compose.override.yml \
        .env.prod.example \
        docker/ \
        frontend/build/ \
        --exclude='*.md' \
        --exclude='.git*'

    # –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    - scp deploy.tar.gz $DEPLOY_USER@$DEPLOY_HOST:/tmp/

    # Deployment
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << 'ENDSSH'
        set -e

        # Backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
        if [ -d /var/www/runtracker/current ]; then
          cp -r /var/www/runtracker/current /var/www/runtracker/backup-$(date +%Y%m%d-%H%M%S)
        fi

        # –ò–∑–≤–ª–µ—á—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
        cd /var/www/runtracker
        mkdir -p releases/$CI_COMMIT_TAG
        cd releases/$CI_COMMIT_TAG
        tar xzf /tmp/deploy.tar.gz
        rm /tmp/deploy.tar.gz

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ production –æ–∫—Ä—É–∂–µ–Ω–∏—è
        cp .env.prod.example .env

        # Pull latest images
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        docker pull $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_TAG
        docker pull $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_TAG

        # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
        if [ -L /var/www/runtracker/current ]; then
          cd /var/www/runtracker/current
          docker-compose down
        fi

        # –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
        ln -sfn /var/www/runtracker/releases/$CI_COMMIT_TAG /var/www/runtracker/current
        cd /var/www/runtracker/current

        # –û—Ç–∫–ª—é—á–∏—Ç—å dev override
        if [ -f docker-compose.override.yml ]; then
          mv docker-compose.override.yml docker-compose.override.yml.disabled
        fi

        # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
        docker-compose up -d
        sleep 10

        # –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
        docker-compose exec -T php-fpm php bin/console doctrine:migrations:migrate --no-interaction
        docker-compose exec -T php-fpm php bin/console cache:clear --env=prod

        # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–ª–∏–∑–æ–≤ (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
        cd /var/www/runtracker/releases
        ls -t | tail -n +6 | xargs -r rm -rf

        echo "‚úÖ Deployment $CI_COMMIT_TAG completed!"
      ENDSSH

    # Health check
    - sleep 5
    - apk add --no-cache curl
    - curl -f https://runtracker.yourdomain.com/api/health || exit 1

  after_script:
    # Rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
    - |
      if [ "$CI_JOB_STATUS" = "failed" ]; then
        ssh $DEPLOY_USER@$DEPLOY_HOST << 'ENDSSH'
          cd /var/www/runtracker
          LAST_BACKUP=$(ls -t backup-* | head -1)
          if [ -n "$LAST_BACKUP" ]; then
            ln -sfn /var/www/runtracker/$LAST_BACKUP /var/www/runtracker/current
            cd current
            docker-compose up -d
            echo "‚ö†Ô∏è Rolled back to $LAST_BACKUP"
          fi
        ENDSSH
      fi

    # Slack —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    - |
      if [ -n "$SLACK_WEBHOOK" ]; then
        STATUS_EMOJI="‚úÖ"
        STATUS_TEXT="Success"
        if [ "$CI_JOB_STATUS" = "failed" ]; then
          STATUS_EMOJI="‚ùå"
          STATUS_TEXT="Failed"
        fi

        curl -X POST $SLACK_WEBHOOK \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"$STATUS_EMOJI Production deployment $CI_COMMIT_TAG: $STATUS_TEXT\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Production Deployment*\n*Tag:* $CI_COMMIT_TAG\n*Status:* $STATUS_TEXT\n*Pipeline:* $CI_PIPELINE_URL\"
                }
              }
            ]
          }"
      fi
