stages:
  - test
  - quality
  - build
  - release
  - deploy

variables:
  REGISTRY: $CI_REGISTRY
  IMAGE_NAME: $CI_PROJECT_PATH
  POSTGRES_DB: test
  POSTGRES_USER: test
  POSTGRES_PASSWORD: test

# ============================================================
# TEST STAGE
# ============================================================

backend-tests:
  stage: test
  image: php:8.4-cli

  services:
    - name: postgres:16-alpine
      alias: postgres

  variables:
    POSTGRES_DB: test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test

  before_script:
    - apt-get update && apt-get install -y libpq-dev libzip-dev zip git
    - docker-php-ext-install pdo_pgsql zip
    - pecl install xdebug && docker-php-ext-enable xdebug
    - cd backend
    # –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –¥–ª—è Symfony
    - |
      cat > .env << 'EOF'
      APP_ENV=test
      APP_SECRET=test_secret_for_ci
      DATABASE_URL=postgresql://test:test@postgres:5432/test?serverVersion=16
      DEFAULT_URI=http://localhost
      EOF
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --prefer-dist --no-progress --no-interaction

  script:
    - php bin/console doctrine:database:create --env=test
    - php bin/console doctrine:schema:create --env=test
    - php bin/phpunit

  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer
    paths:
      - backend/vendor/

  artifacts:
    when: always
    reports:
      junit: backend/coverage.xml
    paths:
      - backend/coverage.xml
    expire_in: 7 days

frontend-tests:
  stage: test
  image: node:22

  before_script:
    - corepack enable
    - cd frontend
    - pnpm install --frozen-lockfile

  script:
    - pnpm check || echo "Type check skipped"
    - pnpm test || echo "Tests skipped"
    - pnpm build

  cache:
    key: ${CI_COMMIT_REF_SLUG}-pnpm
    paths:
      - frontend/node_modules/
      - ~/.pnpm-store

  artifacts:
    paths:
      - frontend/build/
    expire_in: 7 days

# ============================================================
# QUALITY STAGE
# ============================================================

code-quality:
  stage: quality
  image: php:8.4-cli

  only:
    - merge_requests

  before_script:
    - apt-get update && apt-get install -y libpq-dev libzip-dev zip git
    - docker-php-ext-install pdo_pgsql zip
    - cd backend
    # –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –¥–ª—è Symfony
    - |
      cat > .env << 'EOF'
      APP_ENV=test
      APP_SECRET=test_secret_for_ci
      DATABASE_URL=postgresql://test:test@localhost:5432/test?serverVersion=16
      DEFAULT_URI=http://localhost
      EOF
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --prefer-dist --no-progress

  script:
    # PHP CS Fixer - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞
    - vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
    # PHPStan - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
    - vendor/bin/phpstan analyse src tests --memory-limit=2G
    # Deptrac - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (—Å–ª–æ–∏)
    - vendor/bin/deptrac --config-file=deptrac-layers.yaml
    # Deptrac - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–º–æ–¥—É–ª–∏)
    - vendor/bin/deptrac --config-file=deptrac-modules.yaml

  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer
    paths:
      - backend/vendor/

frontend-quality:
  stage: quality
  image: node:22

  only:
    - merge_requests

  before_script:
    - corepack enable
    - cd frontend
    - pnpm install --frozen-lockfile

  script:
    - pnpm lint || echo "Lint not configured"

  cache:
    key: ${CI_COMMIT_REF_SLUG}-pnpm
    paths:
      - frontend/node_modules/

security-audit:
  stage: quality
  image: php:8.4-cli

  before_script:
    - cd backend
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

  script:
    - composer audit || echo "No vulnerabilities"

  allow_failure: true

frontend-security:
  stage: quality
  image: node:22

  before_script:
    - corepack enable
    - cd frontend

  script:
    - pnpm audit || echo "No vulnerabilities"

  allow_failure: true

# ============================================================
# BUILD STAGE (—Ç–æ–ª—å–∫–æ –¥–ª—è main)
# ============================================================

build-php-fpm:
  stage: build
  image: docker:24

  services:
    - docker:24-dind

  only:
    - main
    - tags

  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

  script:
    - cd docker/php-fpm
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        # –î–ª—è —Ç–µ–≥–æ–≤ —Å–æ–∑–¥–∞–µ–º –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
        docker build --target production -t $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_TAG .
        docker build --target production -t $CI_REGISTRY/$IMAGE_NAME/php-fpm:latest .
        docker push $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_TAG
        docker push $CI_REGISTRY/$IMAGE_NAME/php-fpm:latest
      else
        # –î–ª—è main —Å–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–∑—ã —Å sha
        docker build --target production -t $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_REF_NAME .
        docker build --target production -t $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_SHORT_SHA .
        docker push $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_REF_NAME
        docker push $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_SHORT_SHA
      fi

build-nginx:
  stage: build
  image: docker:24

  services:
    - docker:24-dind

  only:
    - main
    - tags

  dependencies:
    - frontend-tests

  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        # –î–ª—è —Ç–µ–≥–æ–≤ —Å–æ–∑–¥–∞–µ–º –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
        docker build -f docker/nginx/Dockerfile.production -t $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_TAG .
        docker build -f docker/nginx/Dockerfile.production -t $CI_REGISTRY/$IMAGE_NAME/nginx:latest .
        docker push $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_TAG
        docker push $CI_REGISTRY/$IMAGE_NAME/nginx:latest
      else
        # –î–ª—è main —Å–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–∑—ã —Å sha
        docker build -f docker/nginx/Dockerfile.production -t $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_REF_NAME .
        docker build -f docker/nginx/Dockerfile.production -t $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_SHORT_SHA .
        docker push $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_REF_NAME
        docker push $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_SHORT_SHA
      fi

# ============================================================
# RELEASE STAGE (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ–≥–æ–≤)
# ============================================================

create-release:
  stage: release
  image: alpine:latest

  only:
    - tags

  when: manual

  before_script:
    - apk add --no-cache git curl jq
    - git fetch --tags

  script:
    - |
      TAG_NAME="$CI_COMMIT_TAG"

      # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–≥–∞
      if ! echo "$TAG_NAME" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+\.[0-9]+)?$'; then
        echo "‚ùå Invalid tag format: $TAG_NAME"
        echo "Tag must follow: vX.Y.Z or vX.Y.Z-beta.N (e.g., v1.0.0 or v1.0.0-beta.1)"
        exit 1
      fi
      echo "‚úÖ Valid tag format: $TAG_NAME"

      # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ pre-release
      IS_PRERELEASE="false"
      if echo "$TAG_NAME" | grep -qE '-(beta|rc|alpha)\.'; then
        IS_PRERELEASE="true"
        echo "‚ö†Ô∏è This is a pre-release version"
      else
        echo "‚úÖ This is a production release"
      fi

      # –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥
      PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')

      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è changelog
      echo "# üöÄ Release $TAG_NAME" > CHANGELOG.md
      echo "" >> CHANGELOG.md

      if [ -n "$PREV_TAG" ]; then
        echo "## üìù Changes since $PREV_TAG" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Features
        echo "### ‚ú® Features" >> CHANGELOG.md
        git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^feat" --grep="^feature" >> CHANGELOG.md || echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Bug Fixes
        echo "### üêõ Bug Fixes" >> CHANGELOG.md
        git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^fix" >> CHANGELOG.md || echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Documentation
        echo "### üìö Documentation" >> CHANGELOG.md
        git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^docs" >> CHANGELOG.md || echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Other Changes
        echo "### üîß Other Changes" >> CHANGELOG.md
        git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" \
          --invert-grep --grep="^feat" --grep="^fix" --grep="^docs" --grep="^feature" >> CHANGELOG.md || echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Statistics
        echo "### üìä Statistics" >> CHANGELOG.md
        COMMITS_COUNT=$(git rev-list --count $PREV_TAG..$TAG_NAME)
        FILES_CHANGED=$(git diff --shortstat $PREV_TAG..$TAG_NAME | awk '{print $1}')
        echo "- **Commits**: $COMMITS_COUNT" >> CHANGELOG.md
        echo "- **Files changed**: ${FILES_CHANGED:-0}" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        echo "**Full Changelog**: $CI_PROJECT_URL/compare/$PREV_TAG...$TAG_NAME" >> CHANGELOG.md
      else
        echo "## üéâ Initial Release" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "This is the first release of RunTracker!" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### Recent Commits" >> CHANGELOG.md
        git log --pretty=format:"- %s (%h)" -n 20 >> CHANGELOG.md || echo "" >> CHANGELOG.md
      fi

      cat CHANGELOG.md

      # –°–æ–∑–¥–∞—Ç—å release —á–µ—Ä–µ–∑ GitLab API
      CHANGELOG_BODY=$(cat CHANGELOG.md | jq -Rs .)

      curl --request POST "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "{
          \"tag_name\": \"$TAG_NAME\",
          \"name\": \"Release $TAG_NAME\",
          \"description\": $CHANGELOG_BODY,
          \"ref\": \"$CI_COMMIT_SHA\"
        }"

      echo "‚úÖ Release $TAG_NAME created successfully!"
      echo "üîó View release: $CI_PROJECT_URL/-/releases/$TAG_NAME"

  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 30 days

# ============================================================
# DEPLOY STAGE (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è production —Ä–µ–ª–∏–∑–æ–≤)
# ============================================================

deploy-production:
  stage: deploy
  image: alpine:latest

  only:
    - tags

  when: manual

  environment:
    name: production
    url: https://runtracker.ru

  dependencies:
    - frontend-tests

  before_script:
    - apk add --no-cache openssh-client rsync tar curl
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - |
      # –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      echo "Checking DEPLOY_KEY availability..."
      echo "DEPLOY_KEY variable exists: $([ -n "$DEPLOY_KEY" ] && echo 'yes' || echo 'no')"
      echo "DEPLOY_KEY as file exists: $([ -f "$DEPLOY_KEY" ] && echo 'yes' || echo 'no')"
      if [ -f "$DEPLOY_KEY" ]; then
        echo "DEPLOY_KEY is a file path: $DEPLOY_KEY"
        cp "$DEPLOY_KEY" ~/.ssh/deploy_key
      elif [ -n "$DEPLOY_KEY" ]; then
        echo "DEPLOY_KEY is a variable, writing to file"
        echo "$DEPLOY_KEY" | tr -d '\r' > ~/.ssh/deploy_key
      else
        echo "ERROR: DEPLOY_KEY is not set or not accessible"
        echo "CI_COMMIT_TAG: $CI_COMMIT_TAG"
        echo "CI_COMMIT_REF_NAME: $CI_COMMIT_REF_NAME"
        echo ""
        echo "Please check:"
        echo "1. GitLab CI/CD Variables: Settings -> CI/CD -> Variables"
        echo "2. Variable 'DEPLOY_KEY' exists and is not masked"
        echo "3. Environment Scope includes tags (should be 'All' or include your tag)"
        echo "4. If variable is Protected, your tag must be protected too"
        exit 1
      fi
    - chmod 600 ~/.ssh/deploy_key
    - |
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ –Ω–µ –ø—É—Å—Ç–æ–π
      if [ ! -f ~/.ssh/deploy_key ]; then
        echo "ERROR: SSH key file was not created"
        exit 1
      fi
      if [ ! -s ~/.ssh/deploy_key ]; then
        echo "ERROR: SSH key file is empty"
        exit 1
      fi
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–∞
      if ! grep -qE "BEGIN.*PRIVATE KEY" ~/.ssh/deploy_key; then
        echo "ERROR: SSH key format is invalid"
        echo "File size: $(wc -c < ~/.ssh/deploy_key) bytes"
        echo "First 200 chars:"
        head -c 200 ~/.ssh/deploy_key || true
        exit 1
      fi
      echo "SSH key format is valid"
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/deploy_key
    - |
      # SSH –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 22)
      SSH_PORT=${DEPLOY_SSH_PORT:-22}
      echo "Using SSH port: $SSH_PORT"
      ssh-keyscan -p $SSH_PORT -H $DEPLOY_HOST >> ~/.ssh/known_hosts || true

  script:
    - echo "Deploying version $CI_COMMIT_TAG"
    - echo "Creating deployment archive..."
    - |
      [ ! -d "frontend/build" ] && mkdir -p frontend/build || echo "frontend/build found"
    - tar czf deploy.tar.gz --exclude='*.md' --exclude='.git*' --exclude='backend/vendor' --exclude='backend/.env*' docker-compose.yml docker-compose.override.yml .env.prod.example docker/ frontend/build/
    - echo "Archive size':' $(du -sh deploy.tar.gz | cut -f1)"
    
    # Upload archive
    - echo "Uploading to server..."
    - scp -P ${DEPLOY_SSH_PORT:-22} deploy.tar.gz $DEPLOY_USER@$DEPLOY_HOST:/tmp/
    
    # Stop old containers
    - echo "Stopping old containers..."
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST '[ -L /opt/run-app/current ] && cd /opt/run-app/current && docker compose down || true'
    
    # Backup current release
    - echo "Creating backup..."
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST '[ -d /opt/run-app/current ] && cp -r /opt/run-app/current /opt/run-app/backup-$(date +%Y%m%d-%H%M%S) || true'
    
    # Prepare new release directory
    - echo "Preparing release directory..."
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "mkdir -p /opt/run-app/releases/$CI_COMMIT_TAG"
    
    # Extract archive
    - echo "Extracting archive..."
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /opt/run-app/releases/$CI_COMMIT_TAG && tar -xzf /tmp/deploy.tar.gz && rm /tmp/deploy.tar.gz && cp .env.prod.example .env"
    
    # Pull Docker images
    - echo "Pulling Docker images..."
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY"
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "docker pull $CI_REGISTRY/$IMAGE_NAME/php-fpm:$CI_COMMIT_TAG"
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "docker pull $CI_REGISTRY/$IMAGE_NAME/nginx:$CI_COMMIT_TAG"
    
    # Switch to new release
    - echo "Switching to new release..."
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "ln -sfn /opt/run-app/releases/$CI_COMMIT_TAG /opt/run-app/current"
    
    # Start containers
    - echo "Starting containers..."
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST 'cd /opt/run-app/current && [ -f docker-compose.override.yml ] && mv docker-compose.override.yml docker-compose.override.yml.disabled || true'
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST 'cd /opt/run-app/current && docker compose up -d'
    
    # Run migrations and clear cache
    - echo "Running migrations..."
    - sleep 10
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST 'cd /opt/run-app/current && docker compose exec -T php-fpm php bin/console doctrine:migrations:migrate --no-interaction'
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST 'cd /opt/run-app/current && docker compose exec -T php-fpm php bin/console cache:clear --env=prod'
    
    # Cleanup old releases (keep last 5)
    - echo "Cleaning up old releases..."
    - ssh -p ${DEPLOY_SSH_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST 'cd /opt/run-app/releases && ls -t | tail -n +6 | xargs -r rm -rf'
    
    # Health check
    - echo "Running health check..."
    - sleep 5
    - curl -f https://runtracker.ru/api/health || exit 1
    - echo "‚úÖ Deployment successful!"

  after_script:
    - |
      if [ "$CI_JOB_STATUS" = "failed" ]; then
        if [ -f ~/.ssh/deploy_key ]; then
          SSH_PORT=${DEPLOY_SSH_PORT:-22}
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST 'cd /opt/run-app && if [ -d releases ] && [ -L current ]; then LAST_BACKUP=$(ls -t backup-* 2>/dev/null | head -1); if [ -n "$LAST_BACKUP" ]; then ln -sfn /opt/run-app/$LAST_BACKUP /opt/run-app/current && cd current && docker compose up -d || true && echo "Rolled back to $LAST_BACKUP"; fi; fi' || true
        fi
      fi
    - |
      if [ -n "$SLACK_WEBHOOK" ]; then
        if [ "$CI_JOB_STATUS" = "failed" ]; then
          STATUS_EMOJI="‚ùå"
          STATUS_TEXT="Failed"
        else
          STATUS_EMOJI="‚úÖ"
          STATUS_TEXT="Success"
        fi
        curl -X POST $SLACK_WEBHOOK -H 'Content-Type: application/json' -d "{\"text\": \"$STATUS_EMOJI Production deployment $CI_COMMIT_TAG: $STATUS_TEXT\"}" || true
      fi
