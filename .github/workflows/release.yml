name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
      
      - name: Validate tag format
        run: |
          TAG_NAME="${{ github.ref_name }}"
          # Allow vX.Y.Z or vX.Y.Z-beta.N, vX.Y.Z-rc.N, vX.Y.Z-alpha.N
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+\.[0-9]+)?$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "Tag must follow: vX.Y.Z or vX.Y.Z-beta.N (e.g., v1.0.0 or v1.0.0-beta.1)"
            exit 1
          fi
          echo "âœ… Valid tag format: $TAG_NAME"
      
      - name: Detect pre-release
        id: prerelease
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" =~ -(beta|rc|alpha)\. ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ This is a pre-release version"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "âœ… This is a production release"
          fi
      
      - name: Get previous tag
        id: previoustag
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            echo "previous_tag=" >> $GITHUB_OUTPUT
            echo "No previous tag found"
          else
            echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
            echo "Previous tag: $PREV_TAG"
          fi
      
      - name: Generate changelog
        id: changelog
        run: |
          TAG_NAME="${{ github.ref_name }}"
          PREV_TAG="${{ steps.previoustag.outputs.previous_tag }}"
          
          echo "# ðŸš€ Release $TAG_NAME" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ -n "$PREV_TAG" ]; then
            echo "## ðŸ“ Changes since $PREV_TAG" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # Group commits by type
            echo "### âœ¨ Features" >> CHANGELOG.md
            git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^feat" --grep="^feature" >> CHANGELOG.md || echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ› Bug Fixes" >> CHANGELOG.md
            git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^fix" >> CHANGELOG.md || echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ“š Documentation" >> CHANGELOG.md
            git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --grep="^docs" >> CHANGELOG.md || echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ”§ Other Changes" >> CHANGELOG.md
            git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" \
              --invert-grep --grep="^feat" --grep="^fix" --grep="^docs" \
              --grep="^feature" >> CHANGELOG.md || echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ“Š Statistics" >> CHANGELOG.md
            COMMITS_COUNT=$(git rev-list --count $PREV_TAG..$TAG_NAME)
            FILES_CHANGED=$(git diff --shortstat $PREV_TAG..$TAG_NAME | awk '{print $1}')
            echo "- **Commits**: $COMMITS_COUNT" >> CHANGELOG.md
            echo "- **Files changed**: ${FILES_CHANGED:-0}" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$TAG_NAME" >> CHANGELOG.md
          else
            echo "## ðŸŽ‰ Initial Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "This is the first release of RunTracker!" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "### Recent Commits" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" -n 20 >> CHANGELOG.md || echo "" >> CHANGELOG.md
          fi
          
          cat CHANGELOG.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notify success
        run: |
          echo "âœ… Release ${{ github.ref_name }} created successfully!"
          echo "ðŸ”— View release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
