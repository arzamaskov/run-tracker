name: CD (Continuous Deployment)

on:
  # Production deployment on releases
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:

  # Build production images (on release)
  build-production-images:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      
    strategy:
      matrix:
        image: [php-fpm, nginx]
        
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.image }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
            
      - name: Build and push PHP-FPM
        if: matrix.image == 'php-fpm'
        uses: docker/build-push-action@v5
        with:
          context: ./docker/php-fpm
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          target: production
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Build and push Nginx
        if: matrix.image == 'nginx'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/nginx/Dockerfile.production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build frontend for production
  build-frontend:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Enable Corepack
        run: corepack enable
        
      - name: Install and build
        working-directory: ./frontend
        run: |
          pnpm install --frozen-lockfile
          pnpm build
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 30

  # Deploy to production (on release)
  deploy-production:
    if: github.event_name == 'release'
    needs: [build-production-images, build-frontend]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://runtracker.yourdomain.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/
          
      - name: Create deployment archive
        run: |
          tar czf deploy.tar.gz \
            docker-compose.yml \
            docker-compose.override.yml \
            .env.prod \
            docker/ \
            frontend/build/ \
            --exclude='*.md' \
            --exclude='.git*'
            
      - name: Copy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "deploy.tar.gz"
          target: "/tmp/"
          
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            
            # Backup current version
            if [ -d /var/www/runtracker/current ]; then
              cp -r /var/www/runtracker/current /var/www/runtracker/backup-$(date +%Y%m%d-%H%M%S)
            fi
            
            # Extract new version
            cd /var/www/runtracker
            mkdir -p releases/${{ github.ref_name }}
            cd releases/${{ github.ref_name }}
            tar xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz
            
            # Setup production environment
            cp .env.prod .env
            
            # Pull latest images
            docker-compose pull
            
            # Stop old version
            if [ -L /var/www/runtracker/current ]; then
              cd /var/www/runtracker/current
              docker-compose down
            fi
            
            # Switch to new version
            ln -sfn /var/www/runtracker/releases/${{ github.ref_name }} /var/www/runtracker/current
            cd /var/www/runtracker/current
            
            # Disable dev override
            if [ -f docker-compose.override.yml ]; then
              mv docker-compose.override.yml docker-compose.override.yml.disabled
            fi
            
            # Start services
            docker-compose up -d
            sleep 10
            
            # Run migrations
            docker-compose exec -T php-fpm php bin/console doctrine:migrations:migrate --no-interaction
            docker-compose exec -T php-fpm php bin/console cache:clear --env=prod
            
            # Cleanup old releases
            cd /var/www/runtracker/releases
            ls -t | tail -n +6 | xargs -r rm -rf
            
            echo "✅ Deployment ${{ github.ref_name }} completed!"
            
      - name: Health check
        run: |
          sleep 5
          curl -f https://runtracker.yourdomain.com/api/health || exit 1
          
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd /var/www/runtracker
            LAST_BACKUP=$(ls -t backup-* | head -1)
            if [ -n "$LAST_BACKUP" ]; then
              ln -sfn /var/www/runtracker/$LAST_BACKUP /var/www/runtracker/current
              cd current
              docker-compose up -d
              echo "⚠️ Rolled back to $LAST_BACKUP"
            fi
            
      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Production ${{ github.ref_name }}: ${{ job.status }}
            Release: ${{ github.event.release.html_url }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
